# Aerospike database configuration file.

# This stanza must come first.
service {
	user 
	group  
	paxos-single-replica-limit 1 # Number of nodes where the replica count is automatically reduced to 1.
	pidfile /var/run/aerospike/asd.pid
	proto-fd-max 15000
	node-id {% include "assets/sub-templates/reverse-formatted-ip.j2" %}
	cluster-name {{ cluster_name }}
	feature_key_file {{ license_location }}/features.conf
}

logging {
	# Log file must be an absolute path.
	file {{ log_location }}/aerospike.log {
		context any info 
	}
        file {{ log_location }} /aerospike-hb.log {
                context hb detail
        }
}

network {
	{% if tls_enabled %}tls {{ tls_name }} {
	    cert-file {{ certs_location }}/server.crt
	    key-file {{ certs_location }}/server.key
	}
	{% endif %}

	service {
		address eth0
		{% if tls_enabled %}tls-port {{ tls_service_port }}
		tls-address any
		tls-name {{ tls_name }}
		tls-authenticate-client false{% else %}port {{ service_port }}
		{% endif %}		
	}

	heartbeat {
		mode mesh
		adddress HEART_BEAT_ADDRESS_1
		address HEART_BEAT_ADDRESS_2
		{% for ip_address in heart_beat_ip_addresses %}mesh-seed-address-port {{ ip_address }} {{ heartbeat_port }}
		{% endfor %}

		interval 150
		timeout 10
	}

	fabric {
		address {{ host_ip['stdout'] }}
		{% if tls_enabled %}tls-port {{ tls_fabric_port }}
		tls-name {{ tls_name }}{% else %}port {{ fabric_port }}{% endif %}		
	}

	info {
		port {{ info_port }}
	}
}


namespace test {
	replication-factor {{ replication_factor }}
	memory-size {{ ( ansible_facts.memtotal_mb * aerospike_mem_pct / 100 ) | int }}M
	default-ttl 0d
	nsup-period 600
	{% if strong_consistency %}strong-consistency true
	{% endif %}

	# To use file storage backing, comment out the line above and use the
	# following lines instead.
	storage-engine device {
		{% for nvme_device in nvme_devices %}device {{ nvme_device }} 
		{% endfor %}data-in-memory false # Store data in memory in addition to
		file {{ namespace_location }}/test.dat
		min-avail-pct 10
	}
}

{% if xdr_enabled %}	

xdr {
	enable-xdr true
        xdr-digestlog-path {{ xdr_digest_log_path }} {{ xdr_digest_log_size }}
        datacenter {{ other_dc_name }} {
				{% for ip_address in other_dc_ips %}
                dc-node-address-port {{ ip_address }} 3000
				{% endfor %}
        }
}

{% endif %}


namespace ns_2 {
	replication-factor {{ replication_factor }}
	memory-size {{ ( ansible_facts.memtotal_mb * aerospike_mem_pct / 100 ) | int }}M
	default-ttl 0d
	nsup-period 600
	{% if strong_consistency %}strong-consistency true
	{% endif %}

	{% if xdr_enabled %}
		enable-xdr true
		xdr-remote-datacenter {{ other_dc_name }} 
	{% endif %}

	# To use file storage backing, comment out the line above and use the
	# following lines instead.
	storage-engine device {
		{% for nvme_device in nvme_devices %}device {{ nvme_device }} 
		{% endfor %}data-in-memory false # Store data in memory in addition to
		file {{ namespace_location }}/test.dat
		min-avail-pct 10
	}
}